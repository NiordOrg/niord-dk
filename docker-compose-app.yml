version: "3.8"

# This scripts will start up all containers that are needed for development.
# After having run docker compose up
# You can start up the Niord app by standing in the niord-dk-web and run > mvn quarkus:dev 

services:

  # image: sfs0cr.azurecr.io/niord-app:20231122.2
  niord-dk-app:
    image: dmadk/niord-app:latest
    container_name: "niord-app"
    ports:
      - "8888:8888"
    restart: no
    depends_on:
      niord-db:
        condition: service_healthy
      niord-keycloak:
        condition: service_healthy
    environment:
      NIORD_DB_URL: "jdbc:mysql://niord-db:3306/niord?allowPublicKeyRetrieval=true&useSSL=false" 
      NIORD_MQ_HOST_PORT: "niord-mq:5672"
#      NIORD_KEYCLOAK_URL: "https://login.t-dma.dk/auth/realms/niord"
      
#      #NIORD_KEYCLOAK_URL: "https://dmassodev.azurewebsites.net/auth/realms/niord"
#      NIORD_KEYCLOAK_URL: "http://niord-keycloak:8080/auth/realms/niord"
      authServerUrl: "http://niord-keycloak:8080/auth"
      frontEndAuthServerUrl: "http://localhost:8080/auth"
      NIORD_HOME: "/opt/niord_home"
    volumes:
      - niord_volume:/opt/niord_home

  busybox:
    image: busybox
    container_name: "niord-dk-app-bootstrap"
    volumes:
      - niord_volume:/opt/niord_home
      - ./niord-dk-dev-basedata.zip:/niord-dk-dev-basedata.zip
    command: >
      /bin/sh -c "
      if [ ! -d '/opt/niord_home/batch-jobs' ]; then
        mkdir -p /opt/niord_home/batch-jobs/batch-sets
        chown -R 185:0 /opt/niord_home
        chmod -R 775 /opt/niord_home
        cp /niord-dk-dev-basedata.zip /opt/niord_home/batch-jobs/batch-sets;
      fi;
      "

volumes:
  niord_volume:
